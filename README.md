# Bit Messenger（ビット伝言ゲーム）

> **教育用Webアプリ**：文字がビット列になり、小包（パケット📦）に分かれてネットワークを進み、受信側で **並べ直し→中身チェック（チェックサム）→復元** されるまでを、**送信ボタンクリックから自動アニメーション**で体験できます。  
> 2人で同じLAN/Wi‑Fi上で遊びながら、**遅延・損失・順序入替・再送（NACK）** の概念を学べます。

---

## 主な特徴

- **無料技術のみ**：HTML/CSS/Vanilla JS + Node.js(ws) + WebRTC DataChannel（STUN: `stun.l.google.com:19302`）
- **UIは1ページ**：上に操作（3要素）、下が可視化（①文字 → ②ビット → ③小包 → ④とどける → ⑤ならべなおす）
- **自動再配達（NACK）**：欠落や破損（チェックサム不一致）を検出すると、該当seqのみ自動で再送
- **視覚表現**：
  - ④ 伝送レーンで📦が左右へ移動（遅延=スライダ + ジッタ）／損失はフェードアウト
  - ⑤ 並べ直しボード（1..total枠）で **欠落は点滅、到着は緑、破損は赤枠⚠️**
  - **到着順リスト**：到着した順を記録。**破損パケットは赤**、重複は薄く表示
- **受信/送信の同期**：各メッセージに **rid（メッセージID）** を付与し、受信側の進捗を送信側に **progress** 通知で“読み取り専用ミラー”表示
- **1画面で全工程**：画面高にフィットするレイアウト。パネル内は内部スクロールで崩れを防止
- **管理ログ（SSE）**：`/admin/logs` でサーバイベントをライブ可視化（フィルタ、JSON/表切替）

---

## セットアップ

### 要件
- Node.js **18 以上**
- ブラウザ：最新の Chrome / Edge / Firefox（2台での動作を推奨）

### 手順

```bash
# 1) 依存を取得
npm install

# 2) サーバ起動
npm run dev   # なければ npm start

# 3) ブラウザでアクセス（同じLANの別端末からもOK）
# 例: http://<サーバPCのIPアドレス>:3000
```

> **補足**：社内ネットワークでP2Pが遮断されることがあります。繋がらない場合は **モバイルテザリング** など別回線を試してください。

---

## 使い方（2人で体験）

1. 二人とも同じURLを開き、同じ **ルームID** を入力 → **「ルームに入る」**
2. 送信者側だけ触れるUIは3つ：
   - **遅延（ms）**：片道の想定遅延。内部で **ジッタ = U(0, delay*0.5)** を加算
   - **損失（%）**：小包が途中で消える確率
   - **テキスト入力＋送信**：クリックを起点に **①→②→③→④→⑤** が自動進行
3. 受信側は操作不要。**欠落/破損を検出すると自動NACK → 再送 → 完了**。  
   すべて埋まると「**ぜんぶ届いたよ！✅**」と原文文字が確定します。

---

## 可視化フロー（学びの順序）

1. **① 文字 → ② ビット列（0.8s）**  
   - UTF‑8バイト列を **8bit区切り**で表示。長文は先頭のみ表示＋ツールチップに全量
2. **③ 小包（パケット化：0.8s）**  
   - ヘッダ：`seq:uint16 / total:uint16 / payloadLen:uint16 / checksum:uint8(総和 mod 256)`  
   - 本体はUTF‑8部分文字列。**カードに「文字＋HEX」**を併記
3. **④ とどける（可変）**  
   - 📦が左→右へ移動。**遅延 + ジッタ**を適用／**損失**時はフェードアウト
4. **⑤ ならべなおす → もとにもどす（自動）**  
   - **到着順リスト**：順番通りに並ぶとは限らない（ジッタで順序入替）  
   - **並べ直しボード**：seq順に配置。**欠落は点滅**、**破損は赤⚠️**、**到着は緑**  
   - 欠落/破損があると **NACK（再配達要求）** を送信側へ → **該当seqだけ再送**  
   - すべて揃うと原文復元して完了

> **重複パケット**は仕様上発生します（元便の遅延と再送便の合流）。並べ直しボードは **最初の1つだけ採用** します。

---

## 通信と擬似ネットワーク

- WebRTC DataChannel：`ordered: false, maxRetransmits: 0`  
  （学習用。**不達・順序入替**を観察できる）
- 送信前キューで適用：  
  **片道遅延 = delay + jitter**（`jitter ~ U(0, delay*0.5)`）、**損失 = 確率破棄**
- 受信側：
  - **欠落/破損（checksum不一致）を検出 → 自動NACK送信 → 該当seqのみ再送**
  - **progress通知**：受信側の進捗（ok/bad/missing/total）を **rid** 付きで送信側へ通知  
    送信側は **同じridのみ反映**（他のメッセージの状態は混ざらない）

> （オプション）重複を減らしたい場合は **NACKに“グレース待ち”＋同一seqのデバウンス** を入れる設計も用意できます。

---

## サーバログ（授業・デバッグ用）

- 形式：**1行1JSON**（`ts, level, roomId, peerId, event, detail`）
- 出力：標準出力 + **リングバッファ（最新2000行）**
- 閲覧：`/admin/logs`（SSEでライブ）  
  - **フィルタ**：level / roomId / peerId / event / キーワード
  - **表示切替**：JSON / 表
  - **操作**：クリア／自動スクロール
- 例：
  - `peer-join / peer-leave`、`relay:signal (offer/answer/ice)`  
  - `relay:nack`（受信側からのNACK通知）、`dc-status`（任意）
- **プライバシ**：メッセージ本文は既定でマスク（詳細モードOFFでは出力しない）

---

## 典型テスト（5分でできる）

### 1) 基本（遅延0 / 損失0 / `HELLO`）
- 1パケットで到着。並べ直しボードの「1」が緑 → **完了**。NACKは出ない。

### 2) 順序入替（遅延800ms / 損失0 / `A..Z` 26B）
- 3パケット。到着順が入れ替わるが、ボードは seq順に整列 → **完了**。

### 3) 欠落→再配達（遅延400ms / 損失30% / 46B）
- 欠落枠が点滅 → **NACK** → 同じseqだけ再送 → 全枠緑で **完了**。  
- `/admin/logs` に `relay:nack` を確認。

### 4) マルチバイト（`こんにちは` / `寿司🍣`）
- ビット列は8bit区切り、パケットカードのテキストは **実文字**で読める。復元一致。

### 5) 長文（`A`×120）
- 10パケット。1画面レイアウトでも崩れず、各ボックスは内部スクロールで表示。

---

## ディレクトリ構成

```
server/
  index.js        # wsシグナリング + /admin/logs + SSE
  logger.js       # JSONロガー & リングバッファ
  rooms.js        # 2人ルーム管理（3人目は拒否）
  public/admin/
    logs.html     # ログ閲覧UI
    logs.js
client/
  index.html      # 1ページUI（上:操作/下:可視化）
  style.css       # 大文字/高コントラスト/1画面フィット
  app.js          # 自動進行・可視化（rid/progress/NACK含む）
  webrtc.js       # 接続/ICE/DataChannel（ordered:false, maxRetransmits:0）
  codec/text.js   # UTF‑8⇄ビット列、パケット化/復元、checksum
README.md
```

---

## アクセシビリティ

- 高コントラスト・大きめ文字・十分な余白
- キーボード操作／フォーカスリング可視
- ツールチップとやさしい語彙（例：小包=パケット📦、再配達🔁=再送/NACK、中身チェック=チェックサム）

---

## 既知の制限・FAQ

- **P2Pが張れない**：企業/学校ネットワークでUDP/ICEがブロックされている場合があります。**モバイルテザリング**や別ネットワークを利用してください。TURNは未使用（教材のため）。
- **重複パケットが多い**：仕様上発生します（元便の遅延と再送便の合流）。見た目を抑えたい場合は **NACKのグレース待ち/デバウンス**を有効にできます。
- **モバイル表示**：PC/タブレット向け最適化。スマホでは高さ調整の都合で一部のパネルが狭くなることがあります。

---

## ライセンス

- 教材・デモ用途での利用を想定しています（プロジェクトに合わせてライセンス文言を追加してください）。

---

## クレジット

- 本デモは **無料OSS** と **ブラウザのWebRTC機能** のみで動作します。アイコン等は各ベンダのポリシーに従います。
